name: 2. PRODUCTION - Deploy and version tag image

on:
    workflow_dispatch:
        inputs:
            commit_tag:
                description: "Commit tag"
                required: true
    release:
        types: [published]

permissions:
    contents: read
    packages: write

jobs:
    build:
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'release'
        runs-on: "ubuntu-latest"
        environment: Production

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event_name == 'release' && github.event.release.tag_name || 'main' }}
                  fetch-depth: 0

            - name: Set tag from event
              id: set_tag
              run: |
                  if [ "${{ github.event_name }}" == "release" ]; then
                    # Extract tag name from release (remove 'v' prefix if present)
                    TAG_NAME="${{ github.event.release.tag_name }}"
                    TAG_NAME="${TAG_NAME#v}"
                    echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
                    echo "Using tag from release event: $TAG_NAME"
                  elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "tag=${{ github.event.inputs.commit_tag }}" >> $GITHUB_OUTPUT
                    echo "Using tag from workflow_dispatch: ${{ github.event.inputs.commit_tag }}"
                  else
                    echo "Unknown event type: ${{ github.event_name }}"
                    exit 1
                  fi

            - name: Validate tag format
              run: |
                  TAG="${{ steps.set_tag.outputs.tag }}"
                  if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "Invalid tag format. Expected format: <number>.<number>.<number>"
                    echo "Received: $TAG"
                    exit 1
                  fi
                  echo "Tag format validated: $TAG"

            - name: Install Doppler CLI
              uses: dopplerhq/cli-action@v3

            - name: Setup Doppler Configuration
              run: |
                  doppler setup --no-prompt --token ${{ secrets.DOPPLER_TOKEN }} --project merchkins-app --config prd
                  echo "Doppler configuration complete for project merchkins-app with config prd"
                  doppler secrets download --no-file --format env > .env
                  echo "Secrets downloaded to .env file."

            - name: Log in to Docker Hub
              uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3
              with:
                  registry: https://index.docker.io/v1/
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push production image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  tags: |
                      merchkins/merchkins:${{ steps.set_tag.outputs.tag }}
                      merchkins/merchkins:latest
                  push: true
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Install Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Deploy to Convex
              run: |
                  bunx convex deploy -y

            - name: Remove env file
              if: always()
              run: |
                  if [ -f .env ]; then
                    rm .env || echo "Warning: Failed to remove .env file"
                  fi
