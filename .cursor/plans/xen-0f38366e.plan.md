<!-- 0f38366e-6607-4d1b-acf7-794587c0a59f 04e636ff-9f89-4c22-b09d-ad92ec2673ee -->
# Xendit Payment Integration Plan

## 1. Install Dependencies

Add `xendit-node` SDK to the project:

- Update `package.json` to include `xendit-node` as a dependency

## 2. Environment Configuration

Add required Xendit credentials to `.env.local`:

- `XENDIT_SECRET_KEY` - Xendit secret API key
- `XENDIT_CALLBACK_TOKEN` - Webhook verification token
- `NEXT_PUBLIC_APP_URL` - Base URL for success/failure redirects

## 3. Update Database Schema

Modify `convex/models/payments.ts` to support Xendit:

- Add `XENDIT` to `paymentMethod` union type
- Remove `CASH`, `BANK_TRANSFER`, `GCASH`, `MAYA`, `OTHERS` (replacing with Xendit)
- Add `xenditInvoiceId` field (optional string)
- Add `xenditInvoiceUrl` field (optional string)
- Add `xenditInvoiceExpiryDate` field (optional number)

Update `convex/models/orders.ts`:

- Add `xenditInvoiceId` field (optional string)
- Add `xenditInvoiceUrl` field (optional string)
- Add `xenditInvoiceExpiryDate` field (optional number)
- Add `xenditInvoiceCreatedAt` field (optional number)

## 4. Create Xendit Service Action

Create `convex/payments/actions/xenditService.ts`:

- Import xendit-node SDK with `"use node";` directive
- Implement `createXenditInvoice` internal action:
- Takes orderId, amount, customerEmail, externalId
- Creates Xendit invoice using Invoice API
- Supports all payment methods (e-wallets, virtual accounts, cards)
- Sets success/failure redirect URLs
- Returns invoice ID, URL, and expiry date
- Implement `checkInvoiceExpiry` helper function:
- Checks if invoice creation timestamp > 24 hours
- Returns boolean indicating if expired

## 5. Update Order Creation Flow

Modify `convex/orders/mutations/createOrder.ts`:

- After order is created, call `createXenditInvoice` action
- Store Xendit invoice details in order document
- Update order with `xenditInvoiceId`, `xenditInvoiceUrl`, `xenditInvoiceExpiryDate`, `xenditInvoiceCreatedAt`

## 6. Create Payment Link Refresh Mutation

Create `convex/orders/mutations/refreshXenditInvoice.ts`:

- Public mutation that takes `orderId`
- Checks if existing invoice is expired (>24hr)
- If expired, creates new Xendit invoice
- Updates order with new invoice details
- Returns new invoice URL

## 7. Webhook Handler Setup

Create `convex/payments/mutations/handleXenditWebhook.ts`:

- Internal mutation to process webhook data
- Validates payment status is "PAID"
- Finds order by `externalId` (matches `xenditInvoiceId`)
- Creates payment record with:
- `paymentMethod: "XENDIT"`
- `paymentStatus: "VERIFIED"`
- `transactionId` from webhook
- `paymentProvider: "XENDIT"`
- Full webhook metadata
- Updates order status to "CONFIRMED"
- Updates order `paymentStatus` to "PAID"
- Triggers `updatePaymentStats` to recalculate order payment totals

Add webhook HTTP endpoint in `convex/http.ts`:

- Route: `/xendit-webhook`
- Method: POST
- Validates `x-callback-token` header against `XENDIT_CALLBACK_TOKEN`
- Parses webhook body
- Calls `handleXenditWebhook` internal mutation
- Returns 200 OK response

## 8. Update Checkout Flow

Modify `src/features/checkout/components/checkout-page.tsx`:

- After order creation succeeds, check if Xendit invoice URL exists
- Redirect user to `xenditInvoiceUrl` instead of `/orders`
- Handle case where invoice might be missing (fallback to orders page)

## 9. Add Payment Link UI

Create `src/features/orders/components/order-payment-link.tsx`:

- Component to display Xendit payment link
- Shows "Pay Now" button if order is PENDING and not paid
- Checks invoice expiry before displaying
- If expired, calls `refreshXenditInvoice` mutation to get new link
- Redirects to Xendit hosted page when clicked

Update `src/features/orders/components/orders-list.tsx`:

- Import and use `OrderPaymentLink` component
- Display payment link for PENDING orders

## 10. Update Payment Method Types

Update `convex/payments/mutations/createPayment.ts`:

- Update `paymentMethod` validator to only include `v.literal("XENDIT")`
- Remove old payment method options

## 11. Add TypeScript Types

Create type definitions for Xendit responses:

- Define `XenditInvoice` interface
- Define `XenditWebhookEvent` interface

## 12. Testing & Validation

- Test order creation creates Xendit invoice
- Test invoice expiry detection (mock 24hr+ old timestamp)
- Test invoice refresh mutation
- Test webhook processing with sample payload
- Verify order auto-confirmation on successful payment
- Verify payment record creation from webhook
- Test redirect flow from checkout to Xendit
- Test "Pay Now" button on orders page

### To-dos

- [ ] Install xendit-node SDK package
- [ ] Add Xendit environment variables to .env.local
- [ ] Update database schema for payments and orders tables with Xendit fields
- [ ] Create Xendit service action with invoice creation and expiry checking
- [ ] Modify order creation to generate Xendit invoice
- [ ] Create mutation to refresh expired payment links
- [ ] Implement webhook handler mutation and HTTP endpoint
- [ ] Update checkout flow to redirect to Xendit payment page
- [ ] Create payment link UI component for orders page
- [ ] Update payment method validators to only use XENDIT
- [ ] Add TypeScript type definitions for Xendit
- [ ] Test complete payment flow and webhook handling