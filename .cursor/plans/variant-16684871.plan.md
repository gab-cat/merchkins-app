<!-- 16684871-eb0c-4b05-b77e-ca252c6dbdc4 8565fdb1-3f92-48db-99fc-eba3c76f94aa -->
# Add Variant Sizes + Dialog Variant/Size Selector

## Scope

- Add optional `sizes` to product variant model (supports labels like "M", "XL", "160mm" and optional per-size price override).
- Redesign product page variant selection to a dialog with 3 sections (top: image + chosen variant/size; middle: variant choices; bottom: size choices if applicable).
- Ensure add-to-cart uses size price when set, else variant price. Persist selected size in cart.

## Decisions

- Pricing: Override strategy — use size.price when set; otherwise fall back to the variant price.
- Cart: Persist selected size (id, label, optional price) per item.

## Data Model Changes

- File: `convex/models/products.ts`
- Add to each `variant` an optional `sizes` field:
- `sizes: v.optional(v.array(v.object({ id: v.string(), label: v.string(), price: v.optional(v.number()) })))`
- Rationale: object form is future-proof, supports pricing and a stable `id`.

- File: `convex/models/carts.ts`
- In `embeddedItems` and `cartItems` add optional `size` object alongside `variantId`:
- `size: v.optional(v.object({ id: v.string(), label: v.string(), price: v.optional(v.number()) }))`
- Keep `productInfo.price` as the effective unit price actually charged (size.price || variant.price) to snapshot price at add time.

## Backend Logic

- File: `convex/carts/mutations/addItem.ts`
- Accept optional `size` in args with validator mirroring cart schema.
- When variant specified, if `size` provided: compute `price = size.price ?? variant.price`.
- Store `size` on the new item and set `productInfo.price` to the computed price.
- Validation: if variant has sizes and `size` absent or not found in that variant, return error.

- File: `convex/carts/mutations/updateItemVariant.ts` (if present)
- Extend to support updating `size` using same validation and price recompute.

- Files: `convex/products/mutations/*` where variants are created/updated
- Extend args to accept `sizes` and validate it; write-through to document.
- No migration needed; `sizes` is optional.

## Product Page UI

- File: `src/features/products/components/product-detail.tsx`
- State: `selectedVariantId`, `selectedSizeId`.
- Replace inline grid/combobox with a compact row:
- Left: current selection summary “Variant: X • Size: Y” or “None selected”.
- Right: Button “Select variant” → opens dialog.
- Dialog content:
- Top: product/variant image; title; chosen variant and size summary; live price display.
- Middle: variant choices (same visual card grid or combobox for many items) – selecting a variant resets `selectedSizeId`.
- Bottom: if selected variant has `sizes`, show grid of size pills (label + optional price); select one to update `selectedSizeId`.
- Close/Confirm: primary button “Use selection” (closes dialog). ESC and overlay close supported.
- Price shown on page: `size.price ?? selectedVariant.price ?? product.minPrice/maxPrice/supposedPrice`.
- Add-to-cart disabled if: active variants exist and `selectedVariantId` is unset; if selected variant has sizes but no `selectedSizeId`.
- On add-to-cart call: pass `variantId` and `size` (id, label, price if available).
- Accessibility: aria-labels for controls; focus trap via `Dialog`.

## Queries

- No changes required to queries returning products; they will automatically include `sizes` due to embedded schema changes.

## Edge Cases

- Products without variants → dialog row hidden; add-to-cart uses product price.
- Variant without sizes → bottom section hidden; no size required.
- Sizes lacking price → fallback to variant price consistently.

## Testing

- Unit (lightweight): helpers for `computeEffectivePrice(variant, size)` and selection guards.
- Manual E2E locally: select variant then size; verify price updates; add to cart; verify cart stores size and price.

## Files to Update

- `convex/models/products.ts`
- `convex/models/carts.ts`
- `convex/carts/mutations/addItem.ts`
- `convex/carts/mutations/updateItemVariant.ts` (if exists)
- `convex/products/mutations/*` (create/update variant functions)
- `src/features/products/components/product-detail.tsx`

## Notes

- Price currency remains PHP as currently rendered.
- No data migration needed; existing documents remain valid.
- Admin UIs for creating/editing variants will be extended in a follow-up (not in scope here).

### To-dos

- [ ] Add optional sizes to product variant schema in products table
- [ ] Add optional size object to cart item schemas
- [ ] Update addItem to accept size and compute price using override fallback
- [ ] Extend updateItemVariant to handle size change and price recompute
- [ ] Extend product variant create/update mutations to accept sizes
- [ ] Replace variant UI with dialog flow and add size selection
- [ ] Centralize effective price computation and use in UI and cart
- [ ] Require size selection when variant has sizes; handle edge cases